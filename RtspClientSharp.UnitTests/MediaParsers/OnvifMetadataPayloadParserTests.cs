using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using RtspClientSharp.Codecs.Audio;
using RtspClientSharp.Codecs.Data;
using RtspClientSharp.MediaParsers;
using RtspClientSharp.RawFrames;
using RtspClientSharp.RawFrames.Audio;
using RtspClientSharp.RawFrames.Data;

namespace RtspClientSharp.UnitTests.MediaParsers
{
    [TestClass]
    public class OnvifMetadataPayloadParserTests
    {
        [TestMethod]
        public void Parse_TestSimpleData_ReturnsValidFrame1()
        {
            var testCodecInfo = new OnvifMetadataCodecInfo();

            string xml = "<tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:MetadataStream>";

            var frames = new List<OnvifMetadataFrame>();
            var parser = new OnvifMetadataPayloadParser(testCodecInfo);
            parser.FrameGenerated = rawFrame => frames.Add((OnvifMetadataFrame)rawFrame);

            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml)), true);

            Assert.AreEqual(1, frames.Count);
            Assert.AreEqual(FrameType.Data, frames[0].Type);
            Assert.AreEqual(xml.Length, frames[0].XmlSegment.Length);
        }

        [TestMethod]
        public void Parse_TestSimpleData_ReturnsValidFrame2()
        {
            var testCodecInfo = new OnvifMetadataCodecInfo();

            string xml = "<tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:MetadataStream>";
            string xml1 = "<tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:MetadataStream>";

            var frames = new List<OnvifMetadataFrame>();
            var parser = new OnvifMetadataPayloadParser(testCodecInfo);
            parser.FrameGenerated = rawFrame => frames.Add((OnvifMetadataFrame)rawFrame);

            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml1)), true);

            Assert.AreEqual(2, frames.Count);
            Assert.AreEqual(FrameType.Data, frames[0].Type);
            Assert.AreEqual(FrameType.Data, frames[1].Type);
        }

        [TestMethod]
        public void Parse_TestSimpleData_ReturnsValidFrame3()
        {
            var testCodecInfo = new OnvifMetadataCodecInfo();

            string xml = "<tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:MetadataStream>";
            string xml1 = "<tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:MetadataStream>";
            string xml2 = "<tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:MetadataStream>";

            var frames = new List<OnvifMetadataFrame>();
            var parser = new OnvifMetadataPayloadParser(testCodecInfo);
            parser.FrameGenerated = rawFrame => frames.Add((OnvifMetadataFrame)rawFrame);

            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml1)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml2)), true);

            Assert.AreEqual(3, frames.Count);
            Assert.AreEqual(FrameType.Data, frames[0].Type);
            Assert.AreEqual(FrameType.Data, frames[1].Type);
            Assert.AreEqual(FrameType.Data, frames[2].Type);
        }

        [TestMethod]
        public void Parse_TestComplexData_ReturnsValidFrame1()
        {
            var testCodecInfo = new OnvifMetadataCodecInfo();

            string xml = "<?xml blabla";
            string xml1 = " ?><tt:Metada";
            string xml2 = "taStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message";
            string xml3 = " UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:Metada";
            string xml4 = "taStream><tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.68760Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.17\" area=\"0.31\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.85\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.85\" y=\"0.03\"></tt:Point><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.86\" y=\"0.02\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.01\"></tt:Point><tt:Point x=\"0.89\" y=\"0.01\"></tt:Point><tt:Point x=\"0.90\" y=\"0.01\"></tt:Point><tt:Point x=\"0.91\" y=\"0.01\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape>";
            string xml5 = "</tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics></tt:Metadat";
            string xml6 = "aStream";
            string xml7 = ">";

            var frames = new List<OnvifMetadataFrame>();
            var parser = new OnvifMetadataPayloadParser(testCodecInfo);
            parser.FrameGenerated = rawFrame => frames.Add((OnvifMetadataFrame)rawFrame);

            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml1)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml2)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml3)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml4)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml5)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml6)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml7)), true);

            Assert.AreEqual(2, frames.Count);
            Assert.AreEqual(FrameType.Data, frames[0].Type);
            Assert.AreEqual(FrameType.Data, frames[1].Type);
        }

        [TestMethod]
        public void Parse_TestComplexData_ReturnsValidFrame2()
        {
            var testCodecInfo = new OnvifMetadataCodecInfo();

            string xml = "<?xml blabla";
            string xml1 = " ?><tt:Metada";
            string xml2 = "taStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.59310Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.34\" area=\"0.29\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.86\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.02\"></tt:Point><tt:Point x=\"0.89\" y=\"0.02\"></tt:Point><tt:Point x=\"0.90\" y=\"0.02\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.04\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape></tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics><tt:Event><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message";
            string xml3 = " UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:IVA/ObjectInField/Detect_any_object</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"false\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage><wsnt:NotificationMessage><wsnt:Topic Dialect=\"http://www.onvif.org/ver10/tev/topicExpression/ConcreteSet\">tns1:VideoSource/MotionAlarm</wsnt:Topic><wsnt:Message><tt:Message UtcTime=\"2019-12-05T15:52:00.59310Z\" PropertyOperation=\"Changed\"><tt:Source><tt:SimpleItem Name=\"Source\" Value=\"1\"></tt:SimpleItem></tt:Source><tt:Key><tt:SimpleItem Name=\"ObjectID\" Value=\"3463\"></tt:SimpleItem></tt:Key><tt:Data><tt:SimpleItem Name=\"State\" Value=\"true\"></tt:SimpleItem></tt:Data></tt:Message></wsnt:Message></wsnt:NotificationMessage></tt:Event></tt:Metada";
            string xml4 = "taStream><tt:MetadataStream xmlns:tt=\"http://www.onvif.org/ver10/schema\" xmlns:wsnt=\"http://docs.oasis-open.org/wsn/b-2\" xmlns:tns1=\"http://www.onvif.org/ver10/topics\"><tt:VideoAnalytics><tt:Frame UtcTime=\"2019-12-05T15:52:00.68760Z\"><tt:Object ObjectId=\"3464\"><tt:Appearance velocity=\"1.17\" area=\"0.31\"><tt:Shape><tt:BoundingBox bottom=\"0.01\" top=\"0.05\" right=\"0.93\" left=\"0.85\"></tt:BoundingBox><tt:CenterOfGravity x=\"0.89\" y=\"0.03\"></tt:CenterOfGravity><tt:Polygon><tt:Point x=\"0.85\" y=\"0.03\"></tt:Point><tt:Point x=\"0.86\" y=\"0.03\"></tt:Point><tt:Point x=\"0.86\" y=\"0.02\"></tt:Point><tt:Point x=\"0.87\" y=\"0.02\"></tt:Point><tt:Point x=\"0.88\" y=\"0.01\"></tt:Point><tt:Point x=\"0.89\" y=\"0.01\"></tt:Point><tt:Point x=\"0.90\" y=\"0.01\"></tt:Point><tt:Point x=\"0.91\" y=\"0.01\"></tt:Point><tt:Point x=\"0.91\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.02\"></tt:Point><tt:Point x=\"0.92\" y=\"0.03\"></tt:Point><tt:Point x=\"0.92\" y=\"0.04\"></tt:Point><tt:Point x=\"0.92\" y=\"0.05\"></tt:Point><tt:Point x=\"0.91\" y=\"0.05\"></tt:Point><tt:Point x=\"0.90\" y=\"0.05\"></tt:Point><tt:Point x=\"0.89\" y=\"0.05\"></tt:Point><tt:Point x=\"0.88\" y=\"0.05\"></tt:Point><tt:Point x=\"0.87\" y=\"0.05\"></tt:Point><tt:Point x=\"0.86\" y=\"0.04\"></tt:Point></tt:Polygon></tt:Shape>";
            string xml5 = "</tt:Appearance></tt:Object></tt:Frame></tt:VideoAnalytics></tt:Metadat";

            var frames = new List<OnvifMetadataFrame>();
            var parser = new OnvifMetadataPayloadParser(testCodecInfo);
            parser.FrameGenerated = rawFrame => frames.Add((OnvifMetadataFrame)rawFrame);

            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml1)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml2)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml3)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml4)), true);
            parser.Parse(TimeSpan.Zero, new ArraySegment<byte>(Encoding.Default.GetBytes(xml5)), true);

            Assert.AreEqual(1, frames.Count);
            Assert.AreEqual(FrameType.Data, frames[0].Type);
        }
    }
}